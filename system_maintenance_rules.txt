---
# Module 9: System Maintenance
module_name: "System Maintenance Security"
module_id: "09_system_maintenance"
version: "1.0.0"

rules:
  # System File Permissions
  - id: SYS-001
    category: "File Permissions"
    description: "Ensure permissions on /etc/passwd are configured"
    severity: "critical"
    apply: |
      chown root:root /etc/passwd
      chmod 644 /etc/passwd
    verify: |
      stat -c %a /etc/passwd | grep -q "644" && echo "PASS" || echo "FAIL"
    rollback: |
      chmod 644 /etc/passwd
    notes: "World-readable but only root writable"

  - id: SYS-002
    category: "File Permissions"
    description: "Ensure permissions on /etc/passwd- are configured"
    severity: "high"
    apply: |
      chown root:root /etc/passwd-
      chmod 600 /etc/passwd-
    verify: |
      if [ -f /etc/passwd- ]; then
        stat -c %a /etc/passwd- | grep -q "600" && echo "PASS" || echo "FAIL"
      else
        echo "SKIP"
      fi
    rollback: |
      chmod 644 /etc/passwd-
    notes: "Backup passwd file"

  - id: SYS-003
    category: "File Permissions"
    description: "Ensure permissions on /etc/group are configured"
    severity: "critical"
    apply: |
      chown root:root /etc/group
      chmod 644 /etc/group
    verify: |
      stat -c %a /etc/group | grep -q "644" && echo "PASS" || echo "FAIL"
    rollback: |
      chmod 644 /etc/group
    notes: "Group file permissions"

  - id: SYS-004
    category: "File Permissions"
    description: "Ensure permissions on /etc/group- are configured"
    severity: "high"
    apply: |
      chown root:root /etc/group-
      chmod 600 /etc/group-
    verify: |
      if [ -f /etc/group- ]; then
        stat -c %a /etc/group- | grep -q "600" && echo "PASS" || echo "FAIL"
      else
        echo "SKIP"
      fi
    rollback: |
      chmod 644 /etc/group-
    notes: "Backup group file"

  - id: SYS-005
    category: "File Permissions"
    description: "Ensure permissions on /etc/shadow are configured"
    severity: "critical"
    apply: |
      chown root:root /etc/shadow
      chmod 640 /etc/shadow
    verify: |
      stat -c %a /etc/shadow | grep -q "640" && echo "PASS" || echo "FAIL"
    rollback: |
      chmod 640 /etc/shadow
    notes: "Shadow password file - highly sensitive"

  - id: SYS-006
    category: "File Permissions"
    description: "Ensure permissions on /etc/shadow- are configured"
    severity: "critical"
    apply: |
      chown root:root /etc/shadow-
      chmod 640 /etc/shadow-
    verify: |
      if [ -f /etc/shadow- ]; then
        stat -c %a /etc/shadow- | grep -q "640" && echo "PASS" || echo "FAIL"
      else
        echo "SKIP"
      fi
    rollback: |
      chmod 640 /etc/shadow-
    notes: "Backup shadow file"

  - id: SYS-007
    category: "File Permissions"
    description: "Ensure permissions on /etc/gshadow are configured"
    severity: "high"
    apply: |
      chown root:root /etc/gshadow
      chmod 640 /etc/gshadow
    verify: |
      if [ -f /etc/gshadow ]; then
        stat -c %a /etc/gshadow | grep -q "640" && echo "PASS" || echo "FAIL"
      else
        echo "SKIP"
      fi
    rollback: |
      chmod 640 /etc/gshadow
    notes: "Group shadow file"

  - id: SYS-008
    category: "File Permissions"
    description: "Ensure permissions on /etc/gshadow- are configured"
    severity: "high"
    apply: |
      chown root:root /etc/gshadow-
      chmod 640 /etc/gshadow-
    verify: |
      if [ -f /etc/gshadow- ]; then
        stat -c %a /etc/gshadow- | grep -q "640" && echo "PASS" || echo "FAIL"
      else
        echo "SKIP"
      fi
    rollback: |
      chmod 640 /etc/gshadow-
    notes: "Backup group shadow file"

  - id: SYS-009
    category: "File Permissions"
    description: "Ensure permissions on /etc/shells are configured"
    severity: "medium"
    apply: |
      chown root:root /etc/shells
      chmod 644 /etc/shells
    verify: |
      stat -c %a /etc/shells | grep -q "644" && echo "PASS" || echo "FAIL"
    rollback: |
      chmod 644 /etc/shells
    notes: "Valid shells list"

  - id: SYS-010
    category: "File Permissions"
    description: "Ensure permissions on /etc/security/opasswd are configured"
    severity: "high"
    apply: |
      if [ -f /etc/security/opasswd ]; then
        chown root:root /etc/security/opasswd
        chmod 600 /etc/security/opasswd
      else
        touch /etc/security/opasswd
        chown root:root /etc/security/opasswd
        chmod 600 /etc/security/opasswd
      fi
    verify: |
      if [ -f /etc/security/opasswd ]; then
        stat -c %a /etc/security/opasswd | grep -q "600" && echo "PASS" || echo "FAIL"
      else
        echo "SKIP"
      fi
    rollback: |
      chmod 600 /etc/security/opasswd
    notes: "Old password file for password history"

  # World Writable Files
  - id: SYS-011
    category: "World Writable"
    description: "Ensure world writable files and directories are secured"
    severity: "high"
    apply: |
      df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -type f -perm -0002 2>/dev/null | while read file; do
        if [ ! -k "$file" ]; then
          echo "WARNING: World writable file without sticky bit: $file"
          chmod o-w "$file" 2>/dev/null || echo "Failed to fix: $file"
        fi
      done
    verify: |
      count=$(df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -type f -perm -0002 ! -perm -1000 2>/dev/null | wc -l)
      if [ "$count" -eq 0 ]; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "Manual permission restoration required"
    notes: "Remove world-write from files without sticky bit"

  - id: SYS-012
    category: "Orphaned Files"
    description: "Ensure no files or directories without an owner exist"
    severity: "medium"
    apply: |
      df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -nouser 2>/dev/null | while read file; do
        echo "WARNING: File without owner: $file - manual review required"
      done
    verify: |
      count=$(df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -nouser 2>/dev/null | wc -l)
      if [ "$count" -eq 0 ]; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "No automated rollback - verification only"
    notes: "Orphaned files should be investigated"

  - id: SYS-013
    category: "Orphaned Files"
    description: "Ensure no files or directories without a group exist"
    severity: "medium"
    apply: |
      df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -nogroup 2>/dev/null | while read file; do
        echo "WARNING: File without group: $file - manual review required"
      done
    verify: |
      count=$(df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -nogroup 2>/dev/null | wc -l)
      if [ "$count" -eq 0 ]; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "No automated rollback - verification only"
    notes: "Files without groups should be investigated"

  # SUID/SGID
  - id: SYS-014
    category: "SUID/SGID"
    description: "Ensure SUID and SGID files are reviewed"
    severity: "high"
    apply: |
      echo "Scanning for SUID/SGID files..."
      df --local -P | awk '{if (NR!=1) print $6}' | xargs -I '{}' find '{}' -xdev -type f \( -perm -4000 -o -perm -2000 \) 2>/dev/null > /var/log/suid-sgid-files.txt
      echo "SUID/SGID files logged to /var/log/suid-sgid-files.txt"
      cat /var/log/suid-sgid-files.txt
    verify: |
      if [ -f /var/log/suid-sgid-files.txt ]; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      rm -f /var/log/suid-sgid-files.txt
    notes: "Manual review required - don't blindly remove SUID/SGID bits"

  # User and Group Validation
  - id: SYS-015
    category: "User Validation"
    description: "Ensure accounts in /etc/passwd use shadowed passwords"
    severity: "critical"
    apply: |
      for user in $(awk -F: '($2 != "x") {print $1}' /etc/passwd); do
        echo "WARNING: User $user does not use shadow passwords"
        pwconv
      done
    verify: |
      if ! awk -F: '($2 != "x") {exit 1}' /etc/passwd; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "Cannot undo pwconv safely"
    notes: "All accounts must use /etc/shadow"

  - id: SYS-016
    category: "User Validation"
    description: "Ensure /etc/shadow password fields are not empty"
    severity: "critical"
    apply: |
      for user in $(awk -F: '($2 == "") {print $1}' /etc/shadow); do
        echo "CRITICAL: User $user has empty password!"
        passwd -l "$user"
      done
    verify: |
      if ! awk -F: '($2 == "") {exit 1}' /etc/shadow; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "Manual password restoration required"
    notes: "Lock accounts with empty passwords"

  - id: SYS-017
    category: "User Validation"
    description: "Ensure all groups in /etc/passwd exist in /etc/group"
    severity: "high"
    apply: |
      for gid in $(cut -d: -f4 /etc/passwd | sort -u); do
        if ! getent group "$gid" >/dev/null; then
          echo "WARNING: GID $gid in /etc/passwd doesn't exist in /etc/group"
        fi
      done
    verify: |
      valid=true
      for gid in $(cut -d: -f4 /etc/passwd | sort -u); do
        if ! getent group "$gid" >/dev/null; then
          valid=false
        fi
      done
      $valid && echo "PASS" || echo "FAIL"
    rollback: |
      echo "No automated rollback - verification only"
    notes: "All referenced groups must exist"

  - id: SYS-018
    category: "Package Management"
    description: "Ensure package manager repositories are configured"
    severity: "medium"
    apply: |
      if command -v apt-get &>/dev/null; then
        apt-get update -qq || echo "WARNING: apt update failed"
      elif command -v yum &>/dev/null; then
        yum check-update || echo "WARNING: yum check-update failed"
      fi
    verify: |
      echo "PASS"
    rollback: |
      echo "No rollback needed"
    notes: "Verify package repositories are accessible"

  - id: SYS-019
    category: "System Updates"
    description: "Check for available security updates"
    severity: "high"
    apply: |
      if command -v apt-get &>/dev/null; then
        apt-get update -qq
        security_updates=$(apt-get upgrade -s | grep -i security | wc -l)
        echo "Security updates available: $security_updates"
      elif command -v yum &>/dev/null; then
        security_updates=$(yum updateinfo list security 2>/dev/null | grep -i security | wc -l)
        echo "Security updates available: $security_updates"
      fi
    verify: |
      echo "PASS"
    rollback: |
      echo "No rollback - check only"
    notes: "Information only - does not install updates"

  - id: SYS-020
    category: "System Hardening"
    description: "Create hardening report"
    severity: "low"
    apply: |
      cat > /var/log/hardening-summary.txt <<EOF
      ========================================
      System Hardening Summary
      ========================================
      Date: $(date)
      Hostname: $(hostname)
      OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)
      Kernel: $(uname -r)
      
      Hardening Modules Applied:
      - Filesystem Security
      - Package Management
      - Services Hardening
      - Network Security
      - Firewall Configuration
      - Access Control (SSH/Sudo/PAM)
      - User Accounts
      - Logging and Auditing
      - System Maintenance
      
      Review logs in /var/log/ for details.
      
      IMPORTANT: 
      - Review firewall rules
      - Test SSH access before logging out
      - Review audit logs regularly
      - Keep system updated
      ========================================
      EOF
      cat /var/log/hardening-summary.txt
    verify: |
      [ -f /var/log/hardening-summary.txt ] && echo "PASS" || echo "FAIL"
    rollback: |
      rm -f /var/log/hardening-summary.txt
    notes: "Generate final hardening report"

  - id: SYS-021
    category: "Post-Hardening"
    description: "Verify critical services are running"
    severity: "critical"
    apply: |
      echo "=== Critical Services Status ==="
      for service in sshd ssh auditd rsyslog systemd-journald; do
        if systemctl is-active "$service" &>/dev/null; then
          echo "✓ $service is running"
        else
          echo "✗ $service is NOT running"
        fi
      done
      
      echo ""
      echo "=== Firewall Status ==="
      if command -v ufw &>/dev/null; then
        ufw status
      elif command -v firewall-cmd &>/dev/null; then
        firewall-cmd --state
      else
        echo "No firewall detected"
      fi
    verify: |
      if systemctl is-active sshd &>/dev/null || systemctl is-active ssh &>/dev/null; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "No rollback - verification only"
    notes: "Final verification of critical services"

  - id: SYS-022
    category: "Backup"
    description: "Create backup of critical configuration files"
    severity: "high"
    apply: |
      backup_dir="/root/hardening-backup-$(date +%Y%m%d-%H%M%S)"
      mkdir -p "$backup_dir"
      
      cp -p /etc/ssh/sshd_config "$backup_dir/" 2>/dev/null || true
      cp -p /etc/sudoers "$backup_dir/" 2>/dev/null || true
      cp -pr /etc/sudoers.d "$backup_dir/" 2>/dev/null || true
      cp -p /etc/pam.d/* "$backup_dir/" 2>/dev/null || true
      cp -p /etc/security/* "$backup_dir/" 2>/dev/null || true
      cp -p /etc/login.defs "$backup_dir/" 2>/dev/null || true
      cp -p /etc/audit/auditd.conf "$backup_dir/" 2>/dev/null || true
      
      tar -czf "$backup_dir.tar.gz" -C "$(dirname $backup_dir)" "$(basename $backup_dir)"
      rm -rf "$backup_dir"
      
      echo "Backup created: $backup_dir.tar.gz"
    verify: |
      if ls /root/hardening-backup-*.tar.gz 1>/dev/null 2>&1; then
        echo "PASS"
      else
        echo "FAIL"
      fi
    rollback: |
      echo "Backups preserved - manual restoration if needed"
    notes: "Backup critical files before hardening"
